<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="WF_ORG_MENU" >
  <resultMap id="WF_ORG_MENUResultMap" class="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    <result column="MENU_CODE" property="menuCode" jdbcType="VARCHAR" />
    <result column="PARENT_MENU_CODE" property="parentMenuCode" jdbcType="VARCHAR" />
    <result column="MENU_NAME" property="menuName" jdbcType="VARCHAR" />
    <result column="MENU_AREA" property="menuArea" jdbcType="VARCHAR" />
    <result column="MENU_LOCATION" property="menuLocation" jdbcType="VARCHAR" />
    <result column="MENU_IMG_LOCATION" property="menuImgLocation" jdbcType="VARCHAR" />
    <result column="MENU_DESC" property="menuDesc" jdbcType="VARCHAR" />
    <result column="MENU_ORDER" property="menuOrder" jdbcType="NUMBER" />
    <result column="MENU_ELEMENT_ID" property="menuElementId" jdbcType="VARCHAR" />
    <result column="MENU_ELEMENT_TYPE" property="menuElementType" jdbcType="VARCHAR" />
    <result column="MENU_TYPE" property="menuType" jdbcType="VARCHAR" />
    <result column="MENU_IS_DEFAULT" property="menuIsDefault" jdbcType="VARCHAR" />
    <result column="MENU_LEVEL" property="menuLevel" jdbcType="NUMBER" />
    <result column="MAX_VALUE" property="maxValue" jdbcType="NUMBER" />
  </resultMap>
  <select id="select" resultMap="WF_ORG_MENUResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    select MENU_CODE, PARENT_MENU_CODE, MENU_NAME, MENU_AREA, MENU_LOCATION, MENU_IMG_LOCATION,
      MENU_DESC, MENU_ORDER, MENU_ELEMENT_ID, MENU_TYPE,MENU_IS_DEFAULT
    from WF_ORG_MENU
  </select>
  
  <resultMap id="WF_ORG_MENU_TreeResultMap" class="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    <result column="MENU_CODE" property="menuCode" jdbcType="VARCHAR" />
    <result column="PARENT_MENU_CODE" property="parentMenuCode" jdbcType="VARCHAR" />
    <result column="MENU_NAME" property="menuName" jdbcType="VARCHAR" />
    <result column="MENU_AREA" property="menuArea" jdbcType="VARCHAR" />
    <result column="MENU_LOCATION" property="menuLocation" jdbcType="VARCHAR" />
    <result column="MENU_IMG_LOCATION" property="menuImgLocation" jdbcType="VARCHAR" />
    <result column="MENU_DESC" property="menuDesc" jdbcType="VARCHAR" />
    <result column="MENU_ELEMENT_ID" property="menuElementId" jdbcType="VARCHAR" />
    <result column="MENU_ELEMENT_TYPE" property="menuElementType" jdbcType="VARCHAR" />
    <result column="MENU_TYPE" property="menuType" jdbcType="VARCHAR" />
    <result column="MENU_IS_DEFAULT" property="menuIsDefault" jdbcType="VARCHAR" />
  </resultMap>
  <select id="selectMenu" resultMap="WF_ORG_MENU_TreeResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	SELECT T.MENU_CODE || '@' || T.MENU_TYPE AS MENU_CODE,
	       ((CASE
	         WHEN T.PARENT_MENU_CODE  = 'RootMenu' THEN
	          NULL
	         ELSE
	          PARENT_MENU_CODE || '@MENU'
	       END)) AS PARENT_MENU_CODE,
	       T.MENU_NAME,
	       T.MENU_IMG_LOCATION,
         T.MENU_DESC,
         T.MENU_LOCATION,
         T.MENU_AREA,
         T.MENU_IS_DEFAULT,
         T.MENU_ELEMENT_ID,
         T.MENU_ELEMENT_TYPE,
         T.MENU_TYPE
	  FROM WF_ORG_MENU T
	<dynamic prepend="WHERE">
		<isNotNull prepend="AND" property="menuCode">
			T.MENU_CODE = #menuCode#
		</isNotNull>
		<isNotEqual prepend="AND" property="userID" compareValue="adminUser">
			 T.MENU_CODE IN
			 (SELECT RESOURCE_ID
			    FROM WF_ORG_RESOURCE_AUTHORITY AUTH
			   WHERE ROLE_ID IN (SELECT #userID#
			                     UNION ALL
			                     SELECT DISTINCT (R.ROLE_ID) ROLE_ID
			                       FROM WF_ORG_USER_ROLE R
			                      WHERE R.USER_ID = #userID#
			                     UNION ALL
			                     SELECT DISTINCT (U.UNIT_ID) ROLE_ID
			                       FROM WF_ORG_USER_UNIT U
			                      WHERE U.USER_ID = #userID#
			                     UNION ALL
			                     SELECT DISTINCT (S.STATION_ID) ROLE_ID
			                       FROM WF_ORG_USER_STATION S
			                      WHERE S.USER_ID = #userID#)
		     AND AUTH.AUTHORITY_TYPE = 'available')
		</isNotEqual>
		<isNotNull prepend="AND" property="menuType">
			T.MENU_TYPE = #menuType#
		</isNotNull>
		<isNotNull prepend="AND" property="menuCategory">
			(T.MENU_CATEGORY = #menuCategory# or T.MENU_CATEGORY is NULL)
		</isNotNull>
	</dynamic>
	 ORDER BY MENU_LEVEL ASC, MENU_ORDER ASC
  </select>
  <select id="selectMenuPart1" resultClass="java.util.HashMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
   SELECT #userID# ROLE_ID
	  UNION ALL
	  SELECT DISTINCT (R.ROLE_ID) ROLE_ID
	    FROM WF_ORG_USER_ROLE R
	   WHERE R.USER_ID = #userID#
		<isEqual prepend="AND" property="roleType" compareValue="bizRole">
            R.ROLE_ID NOT IN (SELECT T3.ROLE_ID
                                FROM WF_ORG_ROLE T3
                               WHERE T3.IS_ADMINROLE = 'æ˜¯')
		</isEqual>
	  UNION ALL
	  SELECT DISTINCT (U.UNIT_ID) ROLE_ID
	    FROM WF_ORG_USER_UNIT U
	   WHERE U.USER_ID = #userID#
	  UNION ALL
	  SELECT DISTINCT (S.STATION_ID) ROLE_ID
	    FROM WF_ORG_USER_STATION S
    WHERE S.USER_ID = #userID#
  </select>
  <select id="selectMenuPart2" resultMap="WF_ORG_MENU_TreeResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	SELECT T.MENU_CODE || '@' || T.MENU_TYPE AS MENU_CODE,
			((CASE
	         WHEN T.PARENT_MENU_CODE  = 'RootMenu' THEN
	          NULL
	         ELSE
	          PARENT_MENU_CODE || '@' ||
	          (SELECT T2.MENU_TYPE
	             FROM WF_ORG_MENU T2
	            WHERE T2.MENU_CODE = T.PARENT_MENU_CODE)
				END)) AS PARENT_MENU_CODE,
	       T.MENU_NAME,
	       T.MENU_IMG_LOCATION,
         T.MENU_DESC,
         T.MENU_LOCATION,
         T.MENU_AREA,
         T.MENU_IS_DEFAULT,
         T.MENU_ELEMENT_ID,
         T.MENU_ELEMENT_TYPE,
         T.MENU_TYPE
	  FROM WF_ORG_MENU T
	<dynamic prepend="WHERE">
		<isNotNull prepend="AND" property="menuCode">
			T.MENU_CODE = #menuCode#
		</isNotNull>
		<isNotEqual prepend="AND" property="userID" compareValue="adminUser">
			 T.MENU_CODE IN
			 (SELECT RESOURCE_ID
			    FROM WF_ORG_RESOURCE_AUTHORITY AUTH
			   WHERE ROLE_ID IN 
					<iterate property="userIdTemp" conjunction="," close=")" open="(" > 
					  #userIdTemp[]:VARCHAR# 
					</iterate>
			<isNull prepend="AND" property="authorityType">
		      AUTH.AUTHORITY_TYPE = 'available')
		    </isNull>
			<isNotNull prepend="AND" property="authorityType">
		      AUTH.AUTHORITY_TYPE = #authorityType#)
		    </isNotNull>
			AND T.MENU_CODE NOT IN
		       (SELECT UE.RESOURCE_ID
		          FROM WF_ORG_USER_EXCLUDE UE
		         WHERE UE.USER_ID = #userID#)
		</isNotEqual>
		<isNotNull prepend="AND" property="menuType">
			T.MENU_TYPE = #menuType#
		</isNotNull>
	</dynamic>
	ORDER BY MENU_LEVEL ASC, MENU_ORDER ASC
  </select>
  
  <select id="selectRootorSubMenu" resultMap="WF_ORG_MENU_TreeResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	SELECT T.MENU_CODE || '@' || T.MENU_TYPE AS MENU_CODE,
	       (T.PARENT_MENU_CODE || '@MENU') AS PARENT_MENU_CODE,
	       T.MENU_NAME,
	       T.MENU_IMG_LOCATION,
         T.MENU_DESC,
         T.MENU_LOCATION,
         T.MENU_AREA,
         T.MENU_IS_DEFAULT,
         T.MENU_ELEMENT_ID,
         T.MENU_ELEMENT_TYPE,
         T.MENU_TYPE
	  FROM WF_ORG_MENU T
     <dynamic prepend="WHERE">
     	<isNull property="menuCode">
	     	<isNull prepend="AND" property="parentMenuCode">
				T.PARENT_MENU_CODE  = 'RootMenu'
			</isNull>
			<isNotEqual  prepend="AND" property="userID" compareValue="adminUser">
				  T.MENU_CODE IN
			 (SELECT RESOURCE_ID
			    FROM WF_ORG_RESOURCE_AUTHORITY AUTH
			   WHERE ROLE_ID IN (SELECT #userID#
			                       FROM DUAL
			                     UNION ALL
			                     SELECT DISTINCT (R.ROLE_ID) ROLE_ID
			                       FROM WF_ORG_USER_ROLE R
			                      WHERE R.USER_ID = #userID#
			                     UNION ALL
			                     SELECT DISTINCT (U.UNIT_ID) ROLE_ID
			                       FROM WF_ORG_USER_UNIT U
			                      WHERE U.USER_ID = #userID#
			                     UNION ALL
			                     SELECT DISTINCT (S.STATION_ID) ROLE_ID
			                       FROM WF_ORG_USER_STATION S
			                      WHERE S.USER_ID = #userID#)
		     AND AUTH.AUTHORITY_TYPE = 'assignable')
	 </isNotEqual>
		</isNull>
		<isNotNull prepend="AND" property="parentMenuCode">
			T.PARENT_MENU_CODE = #parentMenuCode#
		</isNotNull>
		<isNotNull prepend="AND" property="menuCategory">
			(t.MENU_CATEGORY = #menuCategory# or t.MENU_CATEGORY is NULL)
		</isNotNull>
		<isNotNull prepend="AND" property="menuCode">
			T.MENU_CODE = #menuCode#
		</isNotNull>
	</dynamic>
	ORDER BY MENU_LEVEL ASC, MENU_ORDER ASC
  </select>
  <select id="selectRootorSubMenuPart1" resultClass="java.util.HashMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	SELECT #userID# ROLE_ID
     UNION ALL
     SELECT DISTINCT (R.ROLE_ID) ROLE_ID
       FROM WF_ORG_USER_ROLE R
      WHERE R.USER_ID = #userID#
     UNION ALL
     SELECT DISTINCT (U.UNIT_ID) ROLE_ID
       FROM WF_ORG_USER_UNIT U
      WHERE U.USER_ID = #userID#
     UNION ALL
     SELECT DISTINCT (S.STATION_ID) ROLE_ID
       FROM WF_ORG_USER_STATION S
      WHERE S.USER_ID = #userID#
  </select>
  <select id="selectRootorSubMenuPart2" resultMap="WF_ORG_MENU_TreeResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	SELECT T.MENU_CODE || '@' || T.MENU_TYPE AS MENU_CODE,
	       ((CASE
	         WHEN T.PARENT_MENU_CODE  = 'RootMenu' THEN
	          NULL
	         ELSE
	          PARENT_MENU_CODE || '@MENU'
	       END)) AS PARENT_MENU_CODE,
	       T.MENU_NAME,
	       T.MENU_IMG_LOCATION,
         T.MENU_DESC,
         T.MENU_LOCATION,
         T.MENU_AREA,
         T.MENU_IS_DEFAULT,
         T.MENU_ELEMENT_ID,
         T.MENU_ELEMENT_TYPE,
         T.MENU_TYPE
	  FROM WF_ORG_MENU T
     <dynamic prepend="WHERE">
     	<isNull property="menuCode">
	     	<isNull prepend="AND" property="parentMenuCode">
				T.PARENT_MENU_CODE  = 'RootMenu'
			</isNull>
			<isNotEqual  prepend="AND" property="userID" compareValue="adminUser">
				  T.MENU_CODE IN
			 (SELECT RESOURCE_ID
			    FROM WF_ORG_RESOURCE_AUTHORITY AUTH
			   WHERE ROLE_ID IN 
					<iterate property="userIdTemp" conjunction="," close=")" open="(" > 
					  #userIdTemp[]:VARCHAR# 
					</iterate>
			<isNull prepend="AND" property="authorityType">
		      AUTH.AUTHORITY_TYPE = 'assignable')
		    </isNull>
			<isNotNull prepend="AND" property="authorityType">
		      AUTH.AUTHORITY_TYPE = #authorityType#)
		    </isNotNull>
			AND T.MENU_CODE NOT IN
		       (SELECT UE.RESOURCE_ID
		          FROM WF_ORG_USER_EXCLUDE UE
		         WHERE UE.USER_ID = #userID#)
	 		</isNotEqual>
		</isNull>
		<isNotNull prepend="AND" property="parentMenuCode">
			T.PARENT_MENU_CODE = #parentMenuCode#
		</isNotNull>
		<isNotNull prepend="AND" property="menuCode">
			T.MENU_CODE = #menuCode#
		</isNotNull>
	</dynamic>
	ORDER BY MENU_LEVEL ASC, MENU_ORDER ASC
  </select>
  
  <delete id="delete" parameterClass="java.lang.String" >
    delete from WF_ORG_MENU where MENU_CODE = #menuCode#
  </delete>
  <insert id="insert" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU">
    INSERT INTO WF_ORG_MENU (MENU_CODE, PARENT_MENU_CODE, MENU_NAME, MENU_AREA, MENU_LOCATION,
      MENU_IMG_LOCATION, MENU_DESC, MENU_ORDER, MENU_ELEMENT_ID,MENU_ELEMENT_TYPE, 
      MENU_TYPE,MENU_IS_DEFAULT,MENU_LEVEL,MENU_CATEGORY)
    VALUES (#menuCode#, #parentMenuCode:VARCHAR:NULL#, #menuName#, #menuArea:VARCHAR:NULL#, #menuLocation:VARCHAR:NULL#, #menuImgLocation:VARCHAR:NULL#,
      #menuDesc:VARCHAR:NULL#, 
	    (SELECT MAX(ISNULL(MENU_ORDER,0)) + 1
	     FROM WF_ORG_MENU B
	    WHERE B.PARENT_MENU_CODE 
	    <isNotNull prepend=" = " property="parentMenuCode">
	    #parentMenuCode#
	    </isNotNull>
	    <isNull prepend=" is " property="parentMenuCode">
	    null</isNull>),
    #menuElementId:VARCHAR:NULL#,#menuElementType:VARCHAR:NULL#, #menuType#,
    #menuIsDefault#,#menuLevel:NUMBER#, #menuCategory:VARCHAR:NULL#)
  </insert>
  <select id="insertPart1" resultClass="java.util.HashMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	SELECT MAX(ISNULL(MENU_ORDER,0)) + 1 AS MENU_ORDER
	     FROM WF_ORG_MENU B
	    WHERE B.PARENT_MENU_CODE 
    <isNotNull prepend=" = " property="parentMenuCode">
    	#parentMenuCode#
    </isNotNull>
    <isNull prepend=" is " property="parentMenuCode">
    	null
    </isNull>
  </select>
    <insert id="insertPart2" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    INSERT INTO WF_ORG_MENU (MENU_CODE, PARENT_MENU_CODE, MENU_NAME, MENU_AREA, MENU_LOCATION,
      MENU_IMG_LOCATION, MENU_DESC, MENU_ORDER, MENU_ELEMENT_ID,MENU_ELEMENT_TYPE, MENU_TYPE,MENU_IS_DEFAULT,MENU_LEVEL)
    VALUES (#menuCode#, #parentMenuCode:VARCHAR:NULL#, #menuName#, #menuArea:VARCHAR:NULL#, #menuLocation:VARCHAR:NULL#, #menuImgLocation:VARCHAR:NULL#,
      #menuDesc:VARCHAR:NULL#, 
	  #maxValue:NUMBER#,
    #menuElementId:VARCHAR:NULL#,#menuElementType:VARCHAR:NULL#, #menuType#,#menuIsDefault#,#menuLevel:NUMBER#)
  </insert>
  <update id="update" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    UPDATE WF_ORG_MENU
    SET MENU_CODE = #menuCode#,
      PARENT_MENU_CODE = #parentMenuCode#,
      MENU_NAME = #menuName#,
      MENU_AREA = #menuArea#,
      MENU_LOCATION = #menuLocation#,
      MENU_IMG_LOCATION = #menuImgLocation#,
      MENU_DESC = #menuDesc#,
      MENU_ORDER = #menuOrder#,
      MENU_ELEMENT_ID = #menuElementId#,
      MENU_TYPE = #menuType#,
      MENU_IS_DEFAULT = #menuIsDefault#
  </update>
  
   <update id="updateMenu" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    update WF_ORG_MENU
    set 
      MENU_NAME = #menuName#,
      MENU_AREA = #menuArea#,
      MENU_LOCATION = #menuLocation#,
      MENU_IMG_LOCATION = #menuImgLocation#,
      MENU_DESC = #menuDesc:VARCHAR:NULL#,
      MENU_ELEMENT_ID = #menuElementId:VARCHAR:NULL#,
      MENU_IS_DEFAULT = #menuIsDefault#
     where MENU_CODE = #menuCode#
  </update>
  <update id="updateEle" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    UPDATE WF_ORG_MENU
    set 
      MENU_NAME = #menuName#,
      MENU_LOCATION = #menuLocation:VARCHAR:NULL#,
      MENU_IMG_LOCATION = #menuImgLocation:VARCHAR:NULL#,
      MENU_DESC = #menuDesc:VARCHAR:NULL#,
      MENU_ELEMENT_ID = #menuElementId:VARCHAR:NULL#,
      MENU_ELEMENT_TYPE = #menuElementType#
     WHERE MENU_CODE = #menuCode#
  </update>
  
  <update id="updateOrder1" parameterClass="java.lang.String" >
    UPDATE WF_ORG_MENU
    SET 
      MENU_ORDER = MENU_ORDER - 1
     where MENU_CODE = #menuCode#
  </update>
  
  <update id="updateOrder2" parameterClass="java.lang.String" >
    UPDATE WF_ORG_MENU
    SET 
      MENU_ORDER = MENU_ORDER + 1
     where MENU_CODE = #menuCode#
  </update>
</sqlMap>