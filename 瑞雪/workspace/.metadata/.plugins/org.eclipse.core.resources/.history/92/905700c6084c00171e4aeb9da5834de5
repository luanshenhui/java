var messageTable;
var messageID;
var enableValue;
var btnAdvSearchflg= false;
$(function() {
	$.extend($.validator.defaults, {ignore : ""}); // 隐藏控件也校验，去掉此行不验证隐藏控件
	// 初始化表格控件

	
	
	messageTable = $('#messageTable').DataTable({
        "processing": true,
        "serverSide": true,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "dom": '<"bottom"rtflp>',
        "searching": false,
        "pagingType": "full_numbers",
        "deferRender": true,
        "ajax": {
            "url": "/messageDefine/messageDefineList.action",
            "data": function ( d ) {
                     
                     if ($("#advSearchPanel").is(":hidden")) {
                         d.quickSearch = encodeURI($('#quickSearch').val());
                     }
                     else {
                         // 高级查询条件
                         var gEnable = encodeURI($('#gEnable').val());
                         var gTitle =encodeURI($('#gTitle').val());
                         var gSendWay =encodeURI($('#gSendWay').val());
                         var advData = {
                             "enabled": gEnable,
                             "title": gTitle,
                             "sendWay": gSendWay
                         };
                         d.formJson = JSON.stringify(advData);
                     }
            }
        },
        "tableTools": {
            "sRowSelect": "bootstrap"
        },
        "columns": [ {
                "data": "msgCode"
            }, {
                "data": "msgName"
            }, {
                "data": "enabled"
            }, {
                "data": "title"
            }, {
                "data": "sendWay"
            }, {
                "data": "operation"
            }
        ],
        "columnDefs": [{
                "orderable":false,
                "targets":[2]
            },{
                "orderable":false,
                "targets":[3]
            },{
                "orderable":false,
                "targets":[4]
            },{
                "orderable":false,
                "targets":[5]
            }
        ],
        "order": [[ 0, "desc" ],[ 1, "desc" ],[ 3, "desc" ]]
    });
	
	
	
	
	
	
	
	
	
	
	
	
	
	//低级查询按钮
	$("#btnQuickSearch").click(function () {
	    messageTable.draw();
	});

	  // 搜索框的回车事件
	$('#quickSearch').keydown(function(e){
	    if(e.keyCode==13){
	        $("#btnQuickSearch").click();
	    }
	});
	
	
	
	$("#advSearchPanel").click(function () {
	    btnAdvSearchflg = true;
	});
	
	//高级查询按钮
	$("#advSearchSubmit").click(function () {
	    setHidValue("frmAdvSearch");
	    messageTable.draw();
	    $("#advSearchPanel").hide();
	    $("#btnAdvSearch").children("i:eq(0)").removeClass("fa-angle-double-up");
	    $("#btnAdvSearch").children("i:eq(0)").addClass("fa-angle-double-down");
	});

	//高级查询隐藏
	$("#advSearchPanel").hide();
	$("#btnAdvSearch").click(function () {
		btnAdvSearchflg = true;
		if ($("#advSearchPanel").is(":hidden")) {
			$("#advSearchPanel").show();
			$(this).children("i:eq(0)").removeClass("fa-angle-double-down");
			$(this).children("i:eq(0)").addClass("fa-angle-double-up");
		} else {
			$("#advSearchPanel").hide();
			$(this).children("i:eq(0)").removeClass("fa-angle-double-up");
			$(this).children("i:eq(0)").addClass("fa-angle-double-down");
		}
	});


	$("body").click(function(e){ 
	    if(btnAdvSearchflg==true){
	        btnAdvSearchflg = false;
	    } else {
	        $("#advSearchPanel").hide();
	        $("#btnAdvSearch").children("i:eq(0)").removeClass("fa-angle-double-up");
	        $("#btnAdvSearch").children("i:eq(0)").addClass("fa-angle-double-down");    
	    }
	});
	
	$("#FrameMessage").on('hide.bs.modal',function(){
		window.top.window.returnCustomModalDialog();
    });
	
	$("#FrameShop").on('hide.bs.modal', function() {
	    window.top.window.returnCustomModalDialog();
	    window.top.window.borrowCustomModalDialog($("#FrameMessage"));
	});
	$("#FrameTempe").on('hide.bs.modal', function() {
		window.top.window.top.window.returnCustomModalDialog();
		window.top.window.borrowCustomModalDialog($("#FrameShop"));
	});
	
	$("#addMessagePage").click(function(){
		addMessagePage();
	});
	$("#btnMessageAdd").click(function(){
		btnMessageAdd();
	});
	$("#btnTempeAdd").click(function(){
		btnTempeAdd();
	});
	$("#open").click(function(){
		$(this).css("background-color","#e74c3c")
		window.top.window.$("#stop").css("background-color","white")
		window.top.window.$("#openOrStop").val(1)
	});
	$("#stop").click(function(){
		$(this).css("background-color","#e74c3c")
		window.top.window.$("#open").css("background-color","white")
		window.top.window.$("#openOrStop").val(2)
	});
	
	// 快速搜索，点击时提交表格刷新内容
    $("#btnQuickSearch").click(function () {
    	
    });
	
	
	$('#quickSearch').keydown(function(e){
		if(e.keyCode==13){
			$("#btnQuickSearch").click();
		}
	});	
	
});

function addMessagePage(){
	var editDialog = window.top.window.borrowCustomModalDialog($("#FrameMessage"));
	editDialog.modal({show:true, backdrop:'static'});
} 

function btnMessageAdd(){
	window.top.window.returnCustomModalDialog();
	var editDialog = window.top.window.borrowCustomModalDialog($("#FrameShop"));
	editDialog.modal({show:true, backdrop:'static'});
}

function btnTempeAdd(){
	window.top.window.returnCustomModalDialog();
	var editDialog = window.top.window.borrowCustomModalDialog($("#FrameTempe"));
	editDialog.modal({show:true, backdrop:'static'});
}

/**
 * 删除提示
 * @param btnDelete
 * @returns
 */
function operationDelete(btnDelete){
    messageID = $(btnDelete).attr("messageid");
    window.top.window.showModalConfirm("确定要删除该消息吗？", doDelete);
}
function doDelete() {
    if (messageID == "") {
        return;
    }
    $.ajax({
        type:"POST",
        url:"/messageDefine/deleteMgs.action",
        dataType: "json",
        async: false,//同步
        data : {
            msgId : messageID
        },
        success:function(data) {
            if (data.result == "success") {
                window.top.window.showScoMessage('ok', '删除成功');
            } else{
                window.top.window.showModalAlert(data.msg);
            }
        },
        error:function(XMLHttpRequest, textStatus) {
            if (XMLHttpRequest.status == 500) {
                var result = eval("(" + XMLHttpRequest.responseText + ")");
                window.top.window.showModalAlert(result.errorObject.errorText);
            }
        }
    });
    messageID = "";
    messageTable.draw();
}
function operationEnable(valueEnable,btnEnable){
    enableValue = valueEnable;
    messageID = $(btnEnable).attr("messageid");
    window.top.window.showModalConfirm("确定要请用该消息吗？", doEnable);
}
function doEnable() {
    if (messageID == "") {
        return;
    }
    $.ajax({
        type:"POST",
        url:"/messageDefine/doEnable.action",
        dataType: "json",
        async: false,//同步
        data : {
            msgId : messageID,
            enableValue : enableValue
        },
        success:function(data) {
            if (data.result == "success") {
                window.top.window.showScoMessage('ok', '启用成功');
            } else{
                window.top.window.showModalAlert(data.msg);
            }
        },
        error:function(XMLHttpRequest, textStatus) {
            if (XMLHttpRequest.status == 500) {
                var result = eval("(" + XMLHttpRequest.responseText + ")");
                window.top.window.showModalAlert(result.errorObject.errorText);
            }
        }
    });
    messageID = "";
    messageTable.draw();
}