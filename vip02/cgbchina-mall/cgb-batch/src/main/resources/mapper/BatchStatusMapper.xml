<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BatchStatus">
    <select id="selectByObj" parameterType="cn.com.cgbchina.batch.model.BatchStatusModel" resultType="cn.com.cgbchina.batch.model.BatchStatusModel">
        select
          id "id",
          job_name jobName,
          job_param1 jobParam1,
          job_param2 jobParam2,
          job_param3 jobParam3,
          is_success isSuccess,
          run_time runTime,
          exception_msg exceptionMsg
        from tbl_batch_status
        where job_name=#{jobName}
        and date_format(run_time,'%Y%m%d') = #{beginDate}
    </select>

    <!-- 插入任务状态-->
    <insert id="insert" parameterType="cn.com.cgbchina.batch.model.BatchStatusModel">
        insert into tbl_batch_status
        (job_name
        ,job_param1
        ,job_param2
        ,job_param3
        ,is_success
        ,run_time
        ,exception_msg)
        values(#{jobName}
        ,#{jobParam1}
        ,#{jobParam2}
        ,#{jobParam3}
        ,#{isSuccess}
        ,#{runTime}
        ,#{exceptionMsg})
    </insert>

    <update id="updateByPrimaryKey" parameterType="cn.com.cgbchina.batch.model.BatchStatusModel">
        update tbl_batch_status
        set job_name = #{jobName},
        job_param1 = #{jobParam1},
        job_param2 = #{jobParam2},
        job_param3 = #{jobParam3},
        is_success = #{isSuccess},
        run_time = #{runTime},
        exception_msg = #{exceptionMsg}
        where id = #{id}
    </update>
    
    <select id="getFaildReport" resultType="cn.com.cgbchina.batch.model.BatchStatusModel">
    	select
          id "id",
          job_name jobName,
          job_param1 jobParam1,
          job_param2 jobParam2,
          job_param3 jobParam3,
          is_success isSuccess,
          run_time runTime,
          exception_msg exceptionMsg
        from tbl_batch_status
        where is_success=#{flg}
        and ((job_name = 'DayReport' and DATE_FORMAT(run_time, '%Y%m%d') = DATE_FORMAT(DATE_SUB(now(), INTERVAL 1 DAY), '%Y%m%d'))
        OR (job_name = 'WeekReport' and DATE_FORMAT(run_time, '%Y%m%d') = DATE_FORMAT(DATE_SUB(now(), INTERVAL 1 WEEK), '%Y%m%d'))
        OR (job_name = 'MonthReport' and DATE_FORMAT(run_time, '%Y%m%d') = DATE_FORMAT(DATE_SUB(now(), INTERVAL 1 MONTH ), '%Y%m%d')))
    </select>
</mapper>


