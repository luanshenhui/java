<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="WF_ORG_USER" >
  <resultMap id="WF_ORG_USERResultMap" class="com.dhc.organization.user.domain.WF_ORG_USER" >
    <result column="USER_ID" property="userId" jdbcType="VARCHAR" />
    <result column="USER_ACCOUNT" property="userAccount" jdbcType="VARCHAR" />
    <result column="USER_FULLNAME" property="userFullname" jdbcType="VARCHAR" />
    <result column="USER_PASSWORD" property="userPassword" jdbcType="VARCHAR" />
    <result column="USER_DESCRIPTION" property="userDescription" jdbcType="VARCHAR" />
    <result column="USER_PASSWORD_CHANGED" property="userPasswordChanged" jdbcType="TIMESTAMP" />
    <result column="USER_ACCOUNT_ENABLED" property="userAccountEnabled" jdbcType="CHAR" />
    <result column="USER_ACCOUNT_LOCKED" property="userAccountLocked" jdbcType="CHAR" />
    <result column="USER_ACCOUNT_CREATED" property="userAccountCreated" jdbcType="TIMESTAMP" />
  </resultMap>
  
  <resultMap id="WF_ORG_USERResultMap2" class="com.dhc.organization.user.domain.WF_ORG_USER" >
    <result column="USER_ID" property="userId" jdbcType="VARCHAR" />
    <result column="USER_ACCOUNT" property="userAccount" jdbcType="VARCHAR" />
    <result column="USER_FULLNAME" property="userFullname" jdbcType="VARCHAR" />
  </resultMap>
  
  <select id="selectUser" resultMap="WF_ORG_USERResultMap2" parameterClass="java.lang.String" >
	select u.user_id, u.user_fullname, u.user_account
	  from wf_org_user_unit uu
	 inner join wf_org_user u on u.user_id = uu.user_id
	 where uu.unit_id = #unitId#
  </select>
  
  <select id="select" resultMap="WF_ORG_USERResultMap" parameterClass="com.dhc.organization.user.domain.WF_ORG_USER" >
    select USER_ID, USER_ACCOUNT, USER_FULLNAME, USER_PASSWORD, USER_DESCRIPTION,
      USER_PASSWORD_CHANGED, USER_ACCOUNT_ENABLED, (case
         when USER_ACCOUNT_LOCKED = '1' then
          '是'
         else
          '否'
       end) as USER_ACCOUNT_LOCKED, USER_ACCOUNT_CREATED
    from WF_ORG_USER
	<dynamic prepend="WHERE">
		<isNotNull prepend="AND" property="userId">
			USER_ID = #userId#
		</isNotNull>
		<isNotNull prepend="AND" property="userAccount">
			USER_ACCOUNT = #userAccount#
		</isNotNull>
		<isNotNull prepend="AND" property="userFullname">
			USER_FULLNAME like #userFullname#
		</isNotNull>
		<isNotNull prepend="AND" property="userAccountLocked">
			USER_ACCOUNT_LOCKED = #userAccountLocked#
		</isNotNull>
		<isNotNull prepend="AND" property="unitID">
			USER_ID IN
	       (SELECT DISTINCT (B.USER_ID)
	          FROM WF_ORG_UNIT A, WF_ORG_USER_UNIT B
	         WHERE A.UNIT_ID = B.UNIT_ID
	           AND A.UNIT_ID = #unitID#)
		</isNotNull>
		<isNotNull prepend="AND" property="roleId">
			USER_ID IN
	       (SELECT A.USER_ID
	          FROM WF_ORG_USER_ROLE A
	         WHERE A.ROLE_ID = #roleId#)
		</isNotNull>
		<isNotNull prepend="AND" property="stationId">
    		USER_ID IN
	       (SELECT A.USER_ID
	          FROM WF_ORG_USER_STATION A
	         WHERE A.STATION_ID = #stationId#)
		</isNotNull>
		<isNotNull prepend="AND" property="userPassword">
			USER_PASSWORD = #userPassword#
		</isNotNull>
	</dynamic>
   </select>
   
   <select id="selectByIDs" resultMap="WF_ORG_USERResultMap" parameterClass="com.dhc.organization.user.domain.WF_ORG_USER" >
    select USER_ID, USER_ACCOUNT, USER_FULLNAME, USER_PASSWORD, USER_DESCRIPTION,
      USER_PASSWORD_CHANGED, USER_ACCOUNT_ENABLED, USER_ACCOUNT_LOCKED, USER_ACCOUNT_CREATED
    from WF_ORG_USER WHERE USER_ID IN 
		<iterate property="userIds" conjunction="," close=")" open="(" > 
			#userIds[]:VARCHAR# 
		</iterate>
   </select>
   
   <select id="paging" resultMap="WF_ORG_USERResultMap" parameterClass="com.dhc.organization.user.domain.WF_ORG_USER" >
     select DISTINCT USER_ID, USER_ACCOUNT, USER_FULLNAME, USER_PASSWORD, USER_DESCRIPTION,
      USER_PASSWORD_CHANGED, USER_ACCOUNT_ENABLED, USER_ACCOUNT_LOCKED, USER_ACCOUNT_CREATED
	    from 
	    (select DISTINCT U.USER_ID, U.USER_ACCOUNT, U.USER_FULLNAME, U.USER_PASSWORD, U.USER_DESCRIPTION,
	      U.USER_PASSWORD_CHANGED, U.USER_ACCOUNT_ENABLED, (case
	         when U.USER_ACCOUNT_LOCKED = '1' then
	          '是'
	         else
	          '否'
	       end) as USER_ACCOUNT_LOCKED, U.USER_ACCOUNT_CREATED
	    from WF_ORG_USER U
	  LEFT JOIN WF_ORG_USER_UNIT UU ON U.USER_ID = UU.USER_ID
	<dynamic prepend="WHERE">
	    <isNotEqual prepend="AND" property="currentLoginUserID" compareValue="adminUser">
	    	1 = 1
			<isNotNull prepend="AND" property="adminRoleID">
				<![CDATA[	
				(UU.UNIT_ID IS NULL
		    	OR UU.UNIT_ID = ''
				OR U.USER_ID IN (SELECT T1.USER_ID
							     FROM WF_ORG_USER_UNIT T1
						    	WHERE T1.UNIT_ID IN (SELECT T2.UNIT_ID
							                           FROM WF_ORG_ROLE_UNIT T2
							                          WHERE T2.ROLE_ID = #adminRoleID#)))
				AND U.USER_ID <> 'adminUser'
				AND U.USER_ID <> #currentLoginUserID#
				]]>
			</isNotNull>
		</isNotEqual>
		<isNotNull prepend="AND" property="userId">
			U.USER_ID = #userId#
		</isNotNull>
		<isNotNull prepend="AND" property="userAccount">
			U.USER_ACCOUNT = #userAccount#
		</isNotNull>
		<isNotNull prepend="AND" property="userFullname">
			U.USER_FULLNAME = #userFullname#
		</isNotNull>
		<isNotNull prepend="AND" property="userAccountLocked">
			USER_ACCOUNT_LOCKED = #userAccountLocked#
		</isNotNull>
		<isNotNull prepend="AND" property="unitID">
			U.USER_ID IN
	       (SELECT DISTINCT (B.USER_ID)
	          FROM WF_ORG_UNIT A, WF_ORG_USER_UNIT B
	         WHERE A.UNIT_ID = B.UNIT_ID
	           AND A.UNIT_ID = #unitID#)
		</isNotNull>
		<isNotNull prepend="AND" property="roleId">
			U.USER_ID IN
	       (SELECT A.USER_ID
	          FROM WF_ORG_USER_ROLE A
	         WHERE A.ROLE_ID = #roleId#)
		</isNotNull>
		<isNotNull prepend="AND" property="stationId">
    		U.USER_ID IN
	       (SELECT A.USER_ID
	          FROM WF_ORG_USER_STATION A
	         WHERE A.STATION_ID = #stationId#)
		</isNotNull>
		<isNotNull prepend="AND" property="userPassword">
			U.USER_PASSWORD = #userPassword#
		</isNotNull>
		<isEqual prepend="AND" property="userType" compareValue="bizUser">
            U.USER_ID NOT IN (SELECT T2.USER_ID
                                FROM WF_ORG_USER_ROLE T2, WF_ORG_ROLE T3
                               WHERE T2.ROLE_ID = T3.ROLE_ID
                                 AND T3.IS_ADMINROLE = '是')
		</isEqual>
		<isEqual prepend="AND" property="userType" compareValue="adminUser">
           U.USER_ID IN (SELECT T2.USER_ID
                           FROM WF_ORG_USER_ROLE T2, WF_ORG_ROLE T3
                          WHERE T2.ROLE_ID = T3.ROLE_ID
                            AND T3.IS_ADMINROLE = '是')
		</isEqual>
	</dynamic>
		) ttt LIMIT #startRow#, #pageSize#

  </select>
  <delete id="delete" parameterClass="string" >
    delete from WF_ORG_USER where user_id=#value#
  </delete>
  <delete id="deleteUserUnit" parameterClass="string" >
    delete from wf_org_user_unit
	 where user_id = #value#
  </delete>
  <delete id="deleteUserRole" parameterClass="string" >
    delete from wf_org_user_role
	 where user_id = #value#
  </delete>
  <delete id="deleteUserStation" parameterClass="string" >
    delete from WF_ORG_USER_STATION
	 where user_id = #value#
  </delete>
  <delete id="deleteUserPermission" parameterClass="string" >
    delete from wf_org_resource_authority
	 where role_id=#value#
  </delete>
  <insert id="insert" parameterClass="com.dhc.organization.user.domain.WF_ORG_USER" >
    insert into WF_ORG_USER (USER_ID, USER_ACCOUNT, USER_FULLNAME, USER_PASSWORD, USER_DESCRIPTION,
      USER_PASSWORD_CHANGED, USER_ACCOUNT_ENABLED, USER_ACCOUNT_LOCKED, USER_ACCOUNT_CREATED)
    values (#userId#, #userAccount#, #userFullname#, #userPassword#, #userDescription#,
      #userPasswordChanged:DATE#, #userAccountEnabled#, #userAccountLocked#, #userAccountCreated:DATETIME#)
  </insert>
  <insert id="insertUserUnit" parameterClass="com.dhc.organization.unit.domain.WF_ORG_USER_UNIT" >
    insert into wf_org_user_unit
	  (unit_id, user_id)
	values
	  (#unitId#, #userId#)
  </insert>
  <update id="update" parameterClass="com.dhc.organization.user.domain.WF_ORG_USER" >
    update WF_ORG_USER
    set USER_ACCOUNT = #userAccount#,
      USER_FULLNAME = #userFullname#,
      <isNotNull property="userPassword">
      	USER_PASSWORD = #userPassword#,
      	USER_PASSWORD_CHANGED = now(),
      </isNotNull>
      USER_DESCRIPTION = #userDescription#
    where USER_ID = #userId#
  </update>
  
  <update id="lockUser" parameterClass="string" >
    update WF_ORG_USER
    set USER_ACCOUNT_LOCKED = '1'
    where USER_ID= #value#
  </update>
  
  <update id="unlockUser" parameterClass="string" >
    update WF_ORG_USER
    set USER_ACCOUNT_LOCKED = '0'
    where USER_ID= #value#
  </update>
  
  <select id="count" parameterClass="com.dhc.organization.user.domain.WF_ORG_USER" resultClass="java.lang.Integer" >
	SELECT COUNT(*)
	  FROM (select DISTINCT U.USER_ID,
		                U.USER_ACCOUNT,
		                U.USER_FULLNAME,
		                U.USER_PASSWORD,
		                U.USER_DESCRIPTION,
		                U.USER_PASSWORD_CHANGED,
		                U.USER_ACCOUNT_ENABLED,
						U.USER_ACCOUNT_LOCKED,
		                U.USER_ACCOUNT_CREATED
		  FROM WF_ORG_USER U
		  LEFT JOIN WF_ORG_USER_UNIT UU ON U.USER_ID = UU.USER_ID
	<dynamic prepend="WHERE">
	    <isNotEqual prepend="AND" property="currentLoginUserID" compareValue="adminUser">
			1=1
			<isNotNull prepend="AND" property="adminRoleID">
				<![CDATA[
				(UU.UNIT_ID IS NULL
		    	OR UU.UNIT_ID = ''
				OR U.USER_ID IN (SELECT T1.USER_ID
							     FROM WF_ORG_USER_UNIT T1
						    	WHERE T1.UNIT_ID IN (SELECT T2.UNIT_ID
							                           FROM WF_ORG_ROLE_UNIT T2
							                          WHERE T2.ROLE_ID = #adminRoleID#)))
				AND U.USER_ID <> 'adminUser'
				AND U.USER_ID <> #currentLoginUserID#
				]]>
			</isNotNull>
		</isNotEqual>
		<isNotNull prepend="AND" property="userAccount">
			U.USER_ACCOUNT = #userAccount#
		</isNotNull>
		<isNotNull prepend="AND" property="userFullname">
			U.USER_FULLNAME like #userFullname#
		</isNotNull>
		<isNotNull prepend="AND" property="userAccountLocked">
			USER_ACCOUNT_LOCKED = #userAccountLocked#
		</isNotNull>
		<isNotNull prepend="AND" property="unitID">
			U.USER_ID IN
	       (SELECT DISTINCT (B.USER_ID)
	          FROM WF_ORG_UNIT A, WF_ORG_USER_UNIT B
	         WHERE A.UNIT_ID = B.UNIT_ID
	           AND A.UNIT_ID = #unitID#)
		</isNotNull>
		<isNotNull prepend="AND" property="roleId">
			U.USER_ID IN
	       (SELECT A.USER_ID
	          FROM WF_ORG_USER_ROLE A
	         WHERE A.ROLE_ID = #roleId#)
		</isNotNull>
		<isNotNull prepend="AND" property="stationId">
			U.USER_ID IN
	       (SELECT S.USER_ID
	          FROM WF_ORG_USER_STATION S
	         WHERE S.STATION_ID = #stationId#)
		</isNotNull>
		<isNotNull prepend="AND" property="userPassword">
			U.USER_PASSWORD = #userPassword#
		</isNotNull>
	</dynamic>
	) TTT
  </select>
  
   <select id="stationUserRemain" resultClass="java.lang.Integer" parameterClass="string" >
	   <![CDATA[
		SELECT (CASE
		         WHEN (SELECT S1.USER_NUMBERS
		                 FROM WF_ORG_STATION S1
		                WHERE S1.STATION_ID = #value#) < 0 THEN
		          99999999
		         ELSE
		          (SELECT S1.USER_NUMBERS
		             FROM WF_ORG_STATION S1
		            WHERE S1.STATION_ID = #value#)
		       END) -
		       (SELECT COUNT(S.USER_ID)
		          FROM WF_ORG_USER_STATION S
		         WHERE S.STATION_ID = #value#) AS STATION_USERS_REMAIN
		  FROM DUAL
	   ]]>
	</select>
	
   <select id="roleUserRemain" resultClass="java.lang.Integer" parameterClass="string" >
	   <![CDATA[
		SELECT (CASE
		         WHEN (SELECT S1.USER_NUMBERS
		                 FROM WF_ORG_ROLE S1
		                WHERE S1.ROLE_ID = #value#) < 0 THEN
		          99999999
		         ELSE
		          (SELECT S1.USER_NUMBERS
		             FROM WF_ORG_ROLE S1
		            WHERE S1.ROLE_ID = #value#)
		       END) -
		       (SELECT COUNT(S.USER_ID)
		          FROM WF_ORG_USER_ROLE S
		         WHERE S.ROLE_ID = #value#) AS ROLE_USERS_REMAIN
		  FROM DUAL
	   ]]>
	</select>
</sqlMap>