<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="WF_ORG_DELEGATE">
  <resultMap class="com.dhc.authorization.delegate.domain.WF_ORG_DELEGATE" id="WF_ORG_DELEGATEResultMap">
    <result column="DELE_ID" jdbcType="VARCHAR" property="deleId" />
    <result column="USER_ID" jdbcType="VARCHAR" property="userId" />
    <result column="TRUSTOR_ID" jdbcType="VARCHAR" property="trustorId" />
    <result column="DELE_NAME" jdbcType="VARCHAR" property="deleName" />
    <result column="DELE_DESCRIPTION" jdbcType="VARCHAR" property="deleDescription" />
    <result column="DELE_TIME_BEGIN" jdbcType="VARCHAR" property="deleTimeBegin" />
    <result column="DELE_TIME_END" jdbcType="VARCHAR" property="deleTimeEnd" />
    <result column="DELE_ALL_PRIVIL" jdbcType="CHAR" property="deleAllPrivil" />
    <result column="TRUSTOR_NAME" jdbcType="VARCHAR" property="trustor_name" />
    <result column="USER_NAME" jdbcType="VARCHAR" property="userName" />
  </resultMap>
  <select id="select" parameterClass="com.dhc.authorization.delegate.domain.WF_ORG_DELEGATE" resultMap="WF_ORG_DELEGATEResultMap">
    select DELE_ID, user_id,(select u.user_fullname from wf_org_user u where u.user_id = d.USER_ID) user_name, TRUSTOR_ID,(select u.user_fullname from wf_org_user u where u.user_id = trustor_id) trustor_name, DELE_NAME, DELE_DESCRIPTION, 
    to_char(DELE_TIME_BEGIN,'yyyy-mm-dd hh24:mi:ss') as DELE_TIME_BEGIN, to_char(DELE_TIME_END,'yyyy-mm-dd hh24:mi:ss') as DELE_TIME_END, (CASE WHEN DELE_ALL_PRIVIL = 1 THEN '是' ELSE '否' END) AS DELE_ALL_PRIVIL
    from WF_ORG_DELEGATE D  where (user_id in
       (SELECT #currentUserId#
          FROM DUAL
        UNION ALL
        select distinct (uu.user_id)
          from wf_org_user_unit uu
         where uu.unit_id in (select ru.unit_id
                                from wf_org_user_role ur, wf_org_role_unit ru
                               where ur.user_id = #currentUserId#
                                 and ru.role_id = ur.role_id)
        )
      OR TRUSTOR_ID = #currentUserId#)
	<isNotNull prepend="AND" property="deleName">
		DELE_NAME = #deleName#
	</isNotNull>
	<isNotNull prepend="AND" property="userId">
		 USER_ID = #userId#
	</isNotNull>
	<isNotNull prepend="AND" property="trustorId">
		TRUSTOR_ID = #trustorId#
	</isNotNull>
  </select>
  <delete id="delete" parameterClass="java.lang.String">
    delete from WF_ORG_DELEGATE where DELE_ID = #deleId#
  </delete>
  <insert id="insert" parameterClass="com.dhc.authorization.delegate.domain.WF_ORG_DELEGATE">
    insert into WF_ORG_DELEGATE (DELE_ID, USER_ID, TRUSTOR_ID, DELE_NAME, DELE_DESCRIPTION,
      DELE_TIME_BEGIN, DELE_TIME_END, DELE_ALL_PRIVIL)
    values (#deleId#, #userId#, #trustorId#, #deleName#, #deleDescription#, TO_DATE(#deleTimeBegin:VARCHAR:NULL#,'yyyy-mm-dd hh24:mi:ss'),
      TO_DATE(#deleTimeEnd:VARCHAR:NULL#,'yyyy-mm-dd hh24:mi:ss'), #deleAllPrivil#)
  </insert>
  <update id="update" parameterClass="com.dhc.authorization.delegate.domain.WF_ORG_DELEGATE">
    update WF_ORG_DELEGATE
    set 
      USER_ID = #userId#,
      TRUSTOR_ID = #trustorId#,
      DELE_NAME = #deleName#,
      DELE_DESCRIPTION = #deleDescription#,
      DELE_TIME_BEGIN = TO_DATE(#deleTimeBegin:VARCHAR:NULL#,'yyyy-mm-dd hh24:mi:ss'),
      DELE_TIME_END = TO_DATE(#deleTimeEnd:VARCHAR:NULL#,'yyyy-mm-dd hh24:mi:ss'),
      DELE_ALL_PRIVIL = #deleAllPrivil#
     where DELE_ID = #deleId#
  </update>
  <select id="count" parameterClass="com.dhc.authorization.delegate.domain.WF_ORG_DELEGATE" resultClass="java.lang.Integer" >
    select COUNT(*)
    from WF_ORG_DELEGATE D
	<dynamic prepend="WHERE">
		<isNotNull prepend="AND" property="deleName">
			DELE_NAME = #deleName#
		</isNotNull>
		<isNotNull prepend="AND" property="userId">
			 USER_ID = #userId#
		</isNotNull>
		<isNotNull prepend="AND" property="trustorId">
			TRUSTOR_ID = #trustorId#
		</isNotNull>
		<isNotNull prepend="AND" property="deleId">
			DELE_ID != #deleId#
		</isNotNull>
	</dynamic>
  </select>
  <select id="selectDelegateDetail" parameterClass="java.lang.String" resultMap="WF_ORG_DELEGATEResultMap">
	  select d1.DELE_ID,
	       d1.USER_ID,
	       (select u.user_fullname
            from wf_org_user u
            where u.user_id = d1.user_id) user_name,
	       d1.TRUSTOR_ID,
	       (select u.user_fullname
            from wf_org_user u
            where u.user_id = d1.trustor_id) trustor_name,
	       d1.DELE_NAME,
	       d1.DELE_DESCRIPTION,
	       to_char(d1.DELE_TIME_BEGIN, 'yyyy-mm-dd hh24:mi:ss') as DELE_TIME_BEGIN,
	       to_char(d1.DELE_TIME_END, 'yyyy-mm-dd hh24:mi:ss') as DELE_TIME_END,
	       d1.DELE_ALL_PRIVIL
	  from WF_ORG_DELEGATE d1
	  where  d1.dele_id = #deleId#    
  </select>
  <select id="getUserAvailableDelegate" resultMap="WF_ORG_DELEGATEResultMap" parameterClass="java.lang.String" >
  	<![CDATA[
        SELECT
		    DELE_ID,
		    USER_ID,
		    TRUSTOR_ID,
		    DELE_NAME,
		    DELE_DESCRIPTION,
		    DELE_TIME_BEGIN,
		    DELE_TIME_END,
		    DELE_ALL_PRIVIL,
		    '' TRUSTOR_NAME,
		    '' USER_NAME
        FROM
            WF_ORG_DELEGATE
        WHERE
            TRUSTOR_ID = #value#
        AND
            ((
                WF_ORG_DELEGATE.DELE_TIME_BEGIN <= sysdate
            AND WF_ORG_DELEGATE.DELE_TIME_END >= sysdate
            )
         OR
            (
                WF_ORG_DELEGATE.DELE_TIME_BEGIN IS NULL
            AND WF_ORG_DELEGATE.DELE_TIME_END >= sysdate
            )
         OR
            (
                WF_ORG_DELEGATE.DELE_TIME_BEGIN <= sysdate
            AND WF_ORG_DELEGATE.DELE_TIME_END IS NULL
            )
         OR
            (
                WF_ORG_DELEGATE.DELE_TIME_BEGIN IS NULL
            AND WF_ORG_DELEGATE.DELE_TIME_END IS NULL
            ))
  	]]>
  </select>
</sqlMap>