<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="WF_ORG_MENU" >
  <resultMap id="WF_ORG_MENUResultMap" class="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    <result column="MENU_CODE" property="menuCode" jdbcType="VARCHAR" />
    <result column="PARENT_MENU_CODE" property="parentMenuCode" jdbcType="VARCHAR" />
    <result column="MENU_NAME" property="menuName" jdbcType="VARCHAR" />
    <result column="MENU_AREA" property="menuArea" jdbcType="VARCHAR" />
    <result column="MENU_LOCATION" property="menuLocation" jdbcType="VARCHAR" />
    <result column="MENU_IMG_LOCATION" property="menuImgLocation" jdbcType="VARCHAR" />
    <result column="MENU_DESC" property="menuDesc" jdbcType="VARCHAR" />
    <result column="MENU_ORDER" property="menuOrder" jdbcType="NUMBER" />
    <result column="MENU_ELEMENT_ID" property="menuElementId" jdbcType="VARCHAR" />
    <result column="MENU_ELEMENT_TYPE" property="menuElementType" jdbcType="VARCHAR" />
    <result column="MENU_TYPE" property="menuType" jdbcType="VARCHAR" />
    <result column="MENU_IS_DEFAULT" property="menuIsDefault" jdbcType="VARCHAR" />
    <result column="MENU_LEVEL" property="menuLevel" jdbcType="NUMBER" />
  </resultMap>
  <select id="select" resultMap="WF_ORG_MENUResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    select MENU_CODE, PARENT_MENU_CODE, MENU_NAME, MENU_AREA, MENU_LOCATION, MENU_IMG_LOCATION,
      MENU_DESC, MENU_ORDER, MENU_ELEMENT_ID, MENU_TYPE,MENU_IS_DEFAULT
    from WF_ORG_MENU
  </select>
 
 
   <resultMap id="WF_ORG_MENU_TreeResultMap" class="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    <result column="MENU_CODE" property="menuCode" jdbcType="VARCHAR" />
    <result column="PARENT_MENU_CODE" property="parentMenuCode" jdbcType="VARCHAR" />
    <result column="MENU_NAME" property="menuName" jdbcType="VARCHAR" />
    <result column="MENU_AREA" property="menuArea" jdbcType="VARCHAR" />
    <result column="MENU_LOCATION" property="menuLocation" jdbcType="VARCHAR" />
    <result column="MENU_IMG_LOCATION" property="menuImgLocation" jdbcType="VARCHAR" />
    <result column="MENU_DESC" property="menuDesc" jdbcType="VARCHAR" />
    <result column="MENU_ELEMENT_ID" property="menuElementId" jdbcType="VARCHAR" />
    <result column="MENU_ELEMENT_TYPE" property="menuElementType" jdbcType="VARCHAR" />
    <result column="MENU_TYPE" property="menuType" jdbcType="VARCHAR" />
    <result column="MENU_IS_DEFAULT" property="menuIsDefault" jdbcType="VARCHAR" />
  </resultMap>
  <select id="selectMenuPart1" resultClass="java.util.HashMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
   SELECT #userID# ROLE_ID
	 FROM DUAL
	  UNION ALL
	  SELECT DISTINCT (R.ROLE_ID) ROLE_ID
	    FROM WF_ORG_USER_ROLE R
	   WHERE R.USER_ID = #userID#
		<isEqual prepend="AND" property="roleType" compareValue="bizRole">
            R.ROLE_ID NOT IN (SELECT T3.ROLE_ID
                                FROM WF_ORG_ROLE T3
                               WHERE T3.IS_ADMINROLE = 'æ˜¯')
		</isEqual>
	  UNION ALL
	  SELECT DISTINCT (U.UNIT_ID) ROLE_ID
	    FROM WF_ORG_USER_UNIT U
	   WHERE U.USER_ID = #userID#
	  UNION ALL
	  SELECT DISTINCT (S.STATION_ID) ROLE_ID
	    FROM WF_ORG_USER_STATION S
    WHERE S.USER_ID = #userID#
  </select>
  <select id="selectMenu" resultMap="WF_ORG_MENU_TreeResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	select t.menu_code || '@' || t.menu_type as menu_code,
	       ((case
	         when t.parent_menu_code = 'RootMenu' then
	          null
	         else
	          parent_menu_code || '@' ||
	          (SELECT T2.MENU_TYPE
	             FROM WF_ORG_MENU T2
	            WHERE T2.MENU_CODE = T.PARENT_MENU_CODE)
	       end)) as parent_menu_code,
	       t.menu_name,
	       t.menu_img_location,
         t.menu_desc,
         t.menu_location,
         t.menu_area,
         t.menu_is_default,
         t.menu_element_id,
         t.menu_element_type,
         t.menu_type
	  from wf_org_menu t
	<dynamic prepend="WHERE">
		<isNotNull prepend="AND" property="menuCode">
			t.menu_code = #menuCode#
		</isNotNull>
		<isNotEqual prepend="AND" property="userID" compareValue="adminUser">
			  t.menu_code in
			 (SELECT RESOURCE_ID
			    FROM WF_ORG_RESOURCE_AUTHORITY AUTH
			   WHERE ROLE_ID IN 
					<iterate property="userIdTemp" conjunction="," close=")" open="(" > 
					  #userIdTemp[]:VARCHAR# 
					</iterate>
			<isNull prepend="AND" property="authorityType">
		      AUTH.AUTHORITY_TYPE = 'available')
		    </isNull>
			<isNotNull prepend="AND" property="authorityType">
		      AUTH.AUTHORITY_TYPE = #authorityType#)
		    </isNotNull>
		 	 AND T.MENU_CODE NOT IN
		        (SELECT UE.RESOURCE_ID
		           FROM WF_ORG_USER_EXCLUDE UE
		          WHERE UE.USER_ID = #userID#)
		</isNotEqual>
		<isNotNull prepend="AND" property="menuType">
			T.MENU_TYPE = #menuType#
		</isNotNull>
		<isNotNull prepend="AND" property="menuCategory">
			(T.MENU_CATEGORY = #menuCategory# or T.MENU_CATEGORY is NULL)
		</isNotNull>
	</dynamic>
	order by menu_level asc, menu_order asc
  </select>
  
    <select id="selectRootorSubMenu" resultMap="WF_ORG_MENU_TreeResultMap" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
	select t.menu_code || '@' || t.menu_type as menu_code,
	       ((case
	         when t.parent_menu_code = 'RootMenu' then
	          null
	         else
	          parent_menu_code || '@MENU'
	       end)) as parent_menu_code,
	       t.menu_name,
	       t.menu_img_location,
         t.menu_desc,
         t.menu_location,
         t.menu_area,
         t.menu_is_default,
         t.menu_element_id,
         t.menu_element_type,
         t.menu_type
	  from wf_org_menu t
     <dynamic prepend="WHERE">
     	<isNull property="menuCode">
	     	<isNull prepend="AND" property="parentMenuCode">
				t.parent_menu_code = 'RootMenu'
			</isNull>
		</isNull>
		<isNotNull prepend="AND" property="parentMenuCode">
			t.parent_menu_code = #parentMenuCode#
		</isNotNull>
		<isNotNull prepend="AND" property="menuCategory">
			(t.MENU_CATEGORY = #menuCategory# or t.MENU_CATEGORY is NULL)
		</isNotNull>
		<isNotNull prepend="AND" property="menuCode">
			t.menu_code = #menuCode#
		</isNotNull>
	</dynamic>
	<isNotEqual property="userID" compareValue="adminUser">
			 and t.menu_code in
		 (SELECT RESOURCE_ID
		    FROM WF_ORG_RESOURCE_AUTHORITY AUTH
		   WHERE ROLE_ID IN 
					<iterate property="userIdTemp" conjunction="," close=")" open="(" > 
					  #userIdTemp[]:VARCHAR# 
					</iterate>
		<isNull prepend="AND" property="authorityType">
	      AUTH.AUTHORITY_TYPE = 'assignable')
	    </isNull>
		<isNotNull prepend="AND" property="authorityType">
	      AUTH.AUTHORITY_TYPE = #authorityType#)
	    </isNotNull>
		 AND T.MENU_CODE NOT IN
	        (SELECT UE.RESOURCE_ID
	           FROM WF_ORG_USER_EXCLUDE UE
	          WHERE UE.USER_ID = #userID#)
	 </isNotEqual>
		 order by menu_level asc, menu_order asc
  </select>
  
  <delete id="delete" parameterClass="java.lang.String" >
    delete from WF_ORG_MENU where MENU_CODE = #menuCode#
  </delete>
  <insert id="insert" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    insert into WF_ORG_MENU (MENU_CODE, PARENT_MENU_CODE, MENU_NAME, MENU_AREA, MENU_LOCATION,
      MENU_IMG_LOCATION, MENU_DESC, MENU_ORDER, MENU_ELEMENT_ID,MENU_ELEMENT_TYPE, MENU_TYPE,
      MENU_IS_DEFAULT,MENU_LEVEL,MENU_CATEGORY)
    values (#menuCode#, #parentMenuCode:VARCHAR:NULL#, #menuName#, #menuArea:VARCHAR:NULL#, 
    		#menuLocation:VARCHAR:NULL#, #menuImgLocation:VARCHAR:NULL#, #menuDesc:VARCHAR:NULL#, 
	    	nvl((select Max(nvl(menu_order,0)) + 1
				     from wf_org_menu b
				    where b.parent_menu_code 
	    <isNotNull prepend=" = " property="parentMenuCode">
	    #parentMenuCode#
	    </isNotNull>
	    <isNull prepend=" is " property="parentMenuCode">
	    null</isNull>),0), 
    	#menuElementId:VARCHAR:NULL#,#menuElementType:VARCHAR:NULL#, #menuType#,#menuIsDefault#,
    	#menuLevel:NUMBER#, #menuCategory:VARCHAR:NULL#)
  </insert>
  <update id="update" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    update WF_ORG_MENU
    set MENU_CODE = #menuCode#,
      PARENT_MENU_CODE = #parentMenuCode#,
      MENU_NAME = #menuName#,
      MENU_AREA = #menuArea#,
      MENU_LOCATION = #menuLocation#,
      MENU_IMG_LOCATION = #menuImgLocation#,
      MENU_DESC = #menuDesc#,
      MENU_ORDER = #menuOrder#,
      MENU_ELEMENT_ID = #menuElementId#,
      MENU_TYPE = #menuType#,
      MENU_IS_DEFAULT = #menuIsDefault#
  </update>
  
   <update id="updateMenu" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    update WF_ORG_MENU
    set 
      MENU_NAME = #menuName#,
      MENU_AREA = #menuArea#,
      MENU_LOCATION = #menuLocation#,
      MENU_IMG_LOCATION = #menuImgLocation#,
      MENU_DESC = #menuDesc:VARCHAR:NULL#,
      MENU_ELEMENT_ID = #menuElementId:VARCHAR:NULL#,
      MENU_IS_DEFAULT = #menuIsDefault#
     where MENU_CODE = #menuCode#
  </update>
  <update id="updateEle" parameterClass="com.dhc.authorization.resource.menu.domain.WF_ORG_MENU" >
    update WF_ORG_MENU
    set 
      MENU_NAME = #menuName#,
      MENU_LOCATION = #menuLocation:VARCHAR:NULL#,
      MENU_IMG_LOCATION = #menuImgLocation:VARCHAR:NULL#,
      MENU_DESC = #menuDesc:VARCHAR:NULL#,
      MENU_ELEMENT_ID = #menuElementId:VARCHAR:NULL#,
      MENU_ELEMENT_TYPE = #menuElementType#
     where MENU_CODE = #menuCode#
  </update>
  
  <update id="updateOrder1" parameterClass="java.lang.String" >
    update WF_ORG_MENU
    set 
      MENU_ORDER = MENU_ORDER - 1
     where MENU_CODE = #menuCode#
  </update>
  
  <update id="updateOrder2" parameterClass="java.lang.String" >
    update WF_ORG_MENU
    set 
      MENU_ORDER = MENU_ORDER + 1
     where MENU_CODE = #menuCode#
  </update>
</sqlMap>