// 店铺Datatable
var shopTable;
// 正在操作的“店铺ID”
var opShopId="";
var isMultiSelect= "";
var needStation="";
var userID='1906ff5a2f8240cfac6b2fe618d15d33';
var userID='adminUser';
var addList = new ArrayList();
var delList = new ArrayList();
/**
 * 页面初始化
 */
$(function () {
	$("#tabs-2").hide();
	// 输入有效性验证
//	$("#formShopTypeSelect,#validateForm,#shopDetailForm").validate({
//		debug:true,
//        errorPlacement: function(error, element)
//        {
//            error.insertAfter(element);
//        }
//    });
//	$.extend($.validator.defaults,{ignore:""}); //隐藏控件也校验，去掉此行不验证隐藏控件
	
	// 初始化表格控件
    shopTable = $('#userTable').DataTable({
    	"processing": true,
        "serverSide": true,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "dom": '<"bottom"rtflp>',
        "searching": false,
        "pagingType": "full_numbers",
        "deferRender": true,
        "ajax": {
            "url": "/user/userList.action",
            "data": function ( d ) {
                d.quickSearch = encodeURI($('#quickSearch').val());
            }
        },
        "tableTools": {
            "sRowSelect": "bootstrap"
        },
        "columns": [
        	{"data": "chk"},
        	{"data": "userFullname", "searchable": false},
        	{"data": "userAccount"},
        	{"data": "userDescription"},
        	{"data": "userUnits"},
        	{"data": "userRoles"},
        	{"data": "userAccountLocked"}
        ],
        "order": [[ 1, "asc" ]]
    });
    
    // 快速搜索，点击时提交表格刷新内容
    $("#btnQuickSearch").click(function () {
        shopTable.draw();
    });
    
    $("#unitSelect").click(function(){
    	unitSelect();
    });
    
	// 编辑对话框关闭事件发生
    $('#addUser').on('hide.bs.modal', function () {
    	// 父窗体归还本页的编辑对话框
    	window.top.window.returnCustomModalDialog();
    })
    $('#li1').click(function () {
    	subTab(1,this)
    })
    $('#li2').click(function () {
    	subTab(2,this)
    })
    
    // 搜索框的回车事件
    $('#quickSearch').keydown(function(e){
		if(e.keyCode==13){
			$("#btnQuickSearch").click();
		}
	});
    
    // 日期型控件
    $('#divExpireTime').datetimepicker();
    
    /************ 创建店铺向导窗口 ***********/
    $('#rootwizard-custom-circle').bootstrapWizard({
        onTabShow: function(tab, navigation, index) {
        	if (index == 3) {
        		$("#btnShopWizardOK").removeClass("hidden");
        		//$(".button-previous").removeClass("hidden");
        		$(".button-next").addClass("hidden");
        	} else {
        		$("#btnShopWizardOK").addClass("hidden");
        		//$(".button-previous").removeClass("hidden");
        		$(".button-next").removeClass("hidden");
        	}
            var $total = navigation.find('li').length;
            var $current = index+1;
            var $percent = ($current/$total) * 100;
            $('#rootwizard-custom-circle').find('.bar').css({width:$percent+'%'});
        },
        'onNext': function(tab, navigation, index) {
            // 输入有效性验证
        	if(!$("#formShopTypeSelect").valid()) {
        		 return false;
        	}
        	if(!$("#validateForm").valid()) {
        		$('#rootwizard-custom-circle').bootstrapWizard('show',1);
        		return false;
        	}
        	
        	// 检测店铺名称+店铺类型是否唯一
    		if (!isShopUnique(index)) {
            	window.top.window.showModalAlert("店铺名称 + 店铺类型 + 项目名称不唯一");
        		return false;
    		}
        },
        'onTabClick': function(tab, navigation, index) {
            // 输入有效性验证
        	if(!$("#formShopTypeSelect").valid()) {
	       		return false;
	       	}
	       	if(!$("#validateForm").valid()) {
	       		$('#rootwizard-custom-circle').bootstrapWizard('show',1);
	       		return false;
	       	}
	       	
        	// 检测店铺名称+店铺类型是否唯一
//    		if (!isShopUnique(index)) {
//            	window.top.window.showModalAlert("店铺名称 + 店铺类型不唯一");
//        		return false;
//    		}
            // Add class visited to style css
            if (tab.attr("class")=="visited"){
                tab.removeClass("visited");
            } else {
                tab.addClass("visited");
            }
        },
        'tabClass': 'bwizard-steps-o','nextSelector': '.button-next', 'previousSelector': '.button-previous'
    });
    
    // 初始化项目列表
    $.ajax({
        type:"GET",
        url:"/projectManager/getAllAvailableProjects.action",
        contentType: "application/json;charset=utf-8",
        dataType: "json",
        async: true,//同步
        success:function(data) {
            if (data.result == "success") {
            	$("#prjId option").remove();
            	$("#prjId1 option").remove();
            	$("#prjId").append("<option value=''>请选择</option>");
            	$("#prjId1").append("<option value=''>请选择</option>");
                $.each(data.data, function (n, value) {
                    $("#prjId").append("<option value='" + value.prjId + "'>" + value.prjName + "</option>");
                    $("#prjId1").append("<option value='" + value.prjId + "'>" + value.prjName + "</option>");
                });
            } else {
            	window.top.window.showModalAlert(data.msg);
            }
        },
        error:function(XMLHttpRequest, textStatus) {
            if (XMLHttpRequest.status == 500) {
                var result = eval("(" + XMLHttpRequest.responseText + ")");
                alert(result.errorObject.errorText);
            }
        }
    });
    

    // 店铺创建向导页面，需要分单，就禁止选择父店铺
    $("#needSplitOrder").change(function(){
    	if ($("#needSplitOrder").val() == 'y') {
    		$("#parentShop").attr({"disabled":"disabled"});
    		$("#parentShop").val("");
    	} else {
    		$("#parentShop").removeAttr("disabled");
    	}
    })
    
    // 店铺编辑页面，需要分单，就禁止选择父店铺
    $("#needSplitOrder1").change(function(){
    	if ($(this).val() == 'y') {
    		$(this).parent().parent().parent().find("#parentShop1").attr({"disabled":"disabled"});
    		$(this).parent().parent().parent().find("#parentShop1").val("");
    	} else {
    		$(this).parent().parent().parent().find("#parentShop1").removeAttr("disabled");
    	}
    })
});
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function butSave(){
	var unit=$(".selectedTreeRow")[0].innerText;
	var div=window.top.window.borrowCustomModalDialog($("#queryUnitSelect"));
	div.modal('hide');
	$('#userTable').DataTable().ajax.reload(null, false);
	$('#quickSearch').val(unit);
}

function addNewUser(){
	init();
//	$('#rootwizard-custom-user').bootstrapWizard('show',0);
	var editDialog = window.top.window.borrowCustomModalDialog($("#addUser"));
	editDialog.modal({show:true, backdrop:'static'});
} 

function subTab(i,e){
	window.top.window.returnCustomModalDialog();
	if(i==1){
		$("#tabs-2").hide();
		$("#tabs-1").show();
	}else{
		$("#tabs-1").hide();
		$("#tabs-2").show();
//		getExtendDetail();
	}
	$("#li1,#li2").attr({"class":"ui-state-default ui-corner-top"});
	$(e).attr({"class":"ui-state-default ui-corner-top ui-tabs-selected ui-state-active"});
	var editDialog = window.top.window.borrowCustomModalDialog($("#addUser"));
	editDialog.modal({show:true, backdrop:'static'});
}

function getExtendDetail(){
	jQuery.ajax({
		url:"/user/getExtendDetail.action",
		type:"post",
		dataType:"json",
		async:false,
		data:{type:"user"}, //给出扩展信息内容类型
		success:function(data)
		{
			var obj = data.BizTypeDefine.elementList;
			var strHtml = getExtInfo(obj); //获取extInfo
			jQuery("#dyItem").append(strHtml);
			//为cobbobox赋值
			for(var i = 0 ; i<obj.length; i++){				
				if(obj[i].name !="id"){
					if(obj[i].type=="ComboBox"){
						var myOption=document.getElementById(obj[i].name);
						myOption.options[myOption.options.length]=new Option("","");
						for(var j in obj[i].storeValueMap){
							myOption.options[myOption.options.length]=new Option(obj[i].storeValueMap[j],j);
					    }
					}
				}
			}
		}
	});
}

function unitSelect(){
	debugger
	isMultiSelect = true;
	needStation = true;
	window.top.window.returnCustomModalDialog();
	var editDialog = window.top.window.borrowCustomModalDialog($("#addUser"));
	editDialog.modal({show:true, backdrop:'static'});
	queryUnitSelect();
}

function init(){
	$('body').bind('keydown',shieldCommon);
	//处理传入的参数
	//obj = window.dialogArguments;// 定义一个对象用于接收对话框参数

	isMultiSelect = (isMultiSelect && isMultiSelect != "" ? isMultiSelect : false);	
	needStation = (needStation && needStation != "" ? needStation : false);

	//处理树
	tree =new dhtmlXTreeObject("orgTree","100%","100%",0);
    tree.setImagePath("/csh_books/");
    if (isMultiSelect == "true"){
    	tree.enableCheckBoxes(1);
    	tree.enableThreeStateCheckboxes(false);
    }
    if(needStation){
        tree.setOnOpenEndHandler(checkSubNodes);  //解决节点请求回来无法展开
    	tree.setOnMouseInHandler(beforeOpenNode);
    	tree.setXMLAutoLoading("/unit/getSubUnitTree.action?needStation=true"); 
    	tree.loadXML("/unit/getUnitTree.action?needStation=true");
    }else{
        tree.setOnOpenEndHandler(checkSubNodes);  //解决节点请求回来无法展开
    	tree.setOnMouseInHandler(beforeOpenNode);
    	tree.setXMLAutoLoading("/unit/getSubUnitTree.action"); 
    	tree.loadXML("/unit/getUnitTree.action");
    }
    tree.openItem("RootUnit@UNIT");
	window.setTimeout(function() {
		//tree.closeAllItems(0);
	}, 0);
	getUnitTreeManageable();
}

function userPrivAdjust(){
	userPrivAdjustInit();
	$("input[type='checkbox']:checked").each(function(k,v){
		alert(this.getAttribute('userid'));
	});
	$('#rootwizard-custom-privAdjust').bootstrapWizard('show',0);
} 

function userPrivAdjustInit(){
	$('body').bind('keydown',shieldCommon);
	//处理传入的参数
	//obj = window.dialogArguments;// 定义一个对象用于接收对话框参数
	//处理树
	tree =new dhtmlXTreeObject("menuTree","100%","100%",0);
	tree.setImagePath("/csh_books/");
//  tree.setImagePath(webpath+"/view/base/theme/css/redmond/dhtmlxtree/image/DhtxTree/csh_books/");
    tree.enableCheckBoxes(true);
    //tree.attachEvent("onClick",HandleMClk1);
	tree.setOnMouseInHandler(beforeOpenNode);
	tree.setOnOpenEndHandler(checkSubNodes);
	tree.setOnCheckHandler(nodeCheckHandler);
	tree.loadXML("/menu/getMenuTree.action");
	tree.setXMLAutoLoading("/menu/getElementsByMenuItemID.action");
	//把树全展开
	tree.openAllItems(null);
	
	//根据当前选择的（角色、组织、岗位）来获取它对于资源的访问性
	requestPrivilegeAndDrawTree(userID, "user");
	
	//初始化addList和delList里的数据。
	addList = new ArrayList();
	delList = new ArrayList();
	// document.getElementById("userName").innerText=userFullName+"权限调整";
}

/**
 * 根据类型获取权限，并且给权限树打挑
 * @return
 */
function requestPrivilegeAndDrawTree(id,type){
	var sURL1 = "/privilege/getPageElementPrivilege.action";
	$.ajax( {
		url : sURL1,
		type : "post",
		dataType : "json",
		data : {
			type : type,
			id : id,
			isAdminRole : "false"
		},
		success : function(data) {
			if(data.errorMessage == undefined){
				//根据资源授权情况，在树上选中结点
				for(var k in data.authMap) {
				  tree.setCheck(k,1);
				}
				//tree.enableThreeStateCheckboxes(true);
			} else {
				if (data.errorMessage == "session timeout")
					window.location.href = "/login.jsp";
				else
					alert(data.errorMessage);
			}
		},
		error : function(XMLHttpRequest,textStatus,errorThrown){
			alert("操作失败，可能是网络原因");
			// 通常 textStatus 和 errorThrown 之中 
		    // 只有一个会包含信息 
		    //this;  调用本次AJAX请求时传递的options参数
		}
	});
}

function userPrivAdjustSave(){
	var returnObj = new Object();
	if(addList.length <= 0 && delList.length <= 0) {
		window.parent.alert("数据没有改变11111");
		return;
	}

	//保存用户权限
	var returnValue;
	var sURL1 = "/privilege/savePrivileges.action";
	$.ajax( {
		url : sURL1,
		type : "post",
		async: false,
		dataType : "json",
		data : {
			type : "user",
			//id : obj.userID,
			id : userID,
			resIDs4Add: addList.toArray().toString(),
			resIDs4Del: delList.toArray().toString(),
			isAdminRole : "false"
		},
		success : function(data) {
			if(data.errorMessage == undefined){
				window.parent.alert("保存成功");
				//window.returnValue = returnObj;
				returnValue = returnObj;
				//window.close();
			} else {
				if (data.errorMessage == "session timeout")
					window.location.href = "/login.jsp";
				else
					window.parent.alert(data.errorMessage);
				
			}
		},
		error : function(XMLHttpRequest,textStatus,errorThrown){
			window.parent.alert("操作失败，可能是网络原因");
			// 通常 textStatus 和 errorThrown 之中 
		    // 只有一个会包含信息 
		    //this;  调用本次AJAX请求时传递的options参数
		}
	});
	return returnValue;
}

function deleteUser(){
	//存放最终在删除的所有checked用户
	var idString = "";
	$("input[type='checkbox']:checked").each(function(k,v){
		alert(this.getAttribute('userid'));
		if(idString==""){
			idString=this.getAttribute('userid')
		}else if(idString!=""){
			idString+=","+this.getAttribute('userid')
		}
	});
	//删除所选的用户id
	if (idString == null || idString==undefined || idString=="" || idString == ","){
		alert(USER_CHOOSE_USER_TO_DELETE);
		return;
	}
	window.top.window.showModalConfirm( "删除成功", delUser(idString));
}
//锁定用户
function lockUser(queryFormName,listFormName){
	var idString = "";
	$("input[type='checkbox']:checked").each(function(k,v){
		alert(this.getAttribute('userid'));
		if(idString==""){
			idString=this.getAttribute('userid')
		}else if(idString!=""){
			idString+=","+this.getAttribute('userid')
		}
	});
	//删除所选的用户id
	if (idString == null || idString==undefined || idString=="" || idString == ","){
		return;
	}
	var selectedUserID=idString;
	window.top.window.showModalConfirm( "用户已锁定", locked(selectedUserID));
}
function locked(selectedUserID){
	var sURL = "/user/lockUser.action";
	jQuery.ajax( {
		url : sURL,
		type : "post",
		dataType : "json",
		data : {
			userId : selectedUserID,
			isLocked : "否"
		},
		success : function(data) {
			if(data.errorMessage==null || data.errorMessage==undefined){
				$('#userTable').DataTable().ajax.reload(null, false);
			} else {
				if (data.errorMessage == "session timeout")
					window.location.href = "/login.jsp";
				else
					alert(data.errorMessage);
			}
		},
		error : function(XMLHttpRequest,textStatus,errorThrown){
			alert(NET_FAILD);
			// 通常 textStatus 和 errorThrown 之中 
		    // 只有一个会包含信息 
		    //this;  调用本次AJAX请求时传递的options参数
		}
	});
	
	
}


function delUser(userIds){
	var sURL = "/user/deleteUser.action";
	jQuery.ajax( {
		url : sURL,
		type : "post",
		dataType : "json",
		data : {
			userIds : userIds
		},
		success : function(data) {
			if(data.errorMessage==null || data.errorMessage==undefined){
				//删除后重新查询一下，相当于刷新 
				var queryForm=$(queryFormName);
				var queryPara={
					"forward" : "userList",
					"needUserRole" : "1",//只要有此参数，就表示需要提取用户角色
					"itemId" : queryForm["hidUnitID"].value,
					"userAccount" : queryForm["txtUserAccount"].value,
					"userName" : queryForm["txtUserName"].value != "" ? "%"+queryForm["txtRoleName"].value+"%" : ""
				};
				ECSideUtil.queryECForm(listFormName,queryPara,true);
				alert(DELETE_OK);
			} else {
				if (data.errorMessage == "session timeout")
					window.location.href = webpath + "/login.jsp";
				else
					alert(data.errorMessage);
			}
		},
		error : function(XMLHttpRequest,textStatus,errorThrown){
			alert(NET_FAILD);
		}
	});
}

function updateUser(){
	debugger
//	init();
//	$('#rootwizard-custom-user').bootstrapWizard('show',0);
	var editDialog = window.top.window.borrowCustomModalDialog($("#addUser"));
	editDialog.modal({show:true, backdrop:'static'});
	var idString = "";
	$("input[type='checkbox']:checked").each(function(k,v){
		alert(this.getAttribute('userid'));
		if(idString==""){
			idString=this.getAttribute('userid')
		}else if(idString!=""){
			idString+=","+this.getAttribute('userid')
		}
	});
	if (idString == null || idString==undefined || idString=="" || idString == ","){
		return;
	}
	jQuery.ajax( {
		url : "/user/getUserDetail.action",
		type : "post",
		dataType : "json",
		data : {
			userID : idString
		},
		success : function(data) {
			console.log(data)
		},
		error : function(XMLHttpRequest,textStatus,errorThrown){}
	});
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/**
 * 树结点点击事件处理
 * @return
 */
function nodeCheckHandler(id,state){
	//state：1是选中，0是未选中
	if (state == "1" || state == 1){
		if(delList.contains(id))
			delList.remove(id);
		else if(!addList.contains(id))
			addList.add(id);
	} else {
		if(addList.contains(id))
			addList.remove(id);
		else if(!delList.contains(id))
			delList.add(id);
	}
}
function getUnitTreeManageable(){	
	jQuery.ajax({
		url:"/unit/getUnitTreeManageable.action",
		type:"post",
		async:false,
		dataType:"json",
		success:function(data){
			if(data.errorMessage==null || data.errorMessage==undefined){
				for(var i=0;i<data.length;i++){
					if(data[i].MANAGEABLE != 1){
						tree.showItemCheckbox(data[i].UNIT_ID,false); //隐藏复选框
						tree.setItemColor(data[i].UNIT_ID,"#aaaaaa","#aaaaaa");//节点字体颜色置灰
					}
				}
			} else {
				if (data.errorMessage == "session timeout")
					window.location.href = webpath + "/login.jsp";
				else
					alert(data.errorMessage);
			}
		}
	});
	
}


function queryUnitSelect(){
	init();
	$('#rootwizard-custom-circle').bootstrapWizard('show',0);
}


/*
 * tree设置节点展开
 * */
var nodeClickArray = new ArrayList(); //节点点击数组
var beforeOpenSubNodes;
function checkSubNodes(id,state){
	//记录点击过的节点，第一次单击则请求数据，然后记录；当再次点击后则不再请求数据。
	if(nodeClickArray.contains(id))
		return true;
	else{
		nodeClickArray.add(id);
		//2011年4月12日 wangxy
		//如果父结点是灰的，则需要对子结点的使用状态进行判断
		//如果父结点不是灰的，则所有子结点是可用状态。
		var itemColor = tree.getItemColor(id);
		//通过节点颜色判断是否有操作权限
		if(itemColor.acolor == "#aaaaaa"){
			getSubUnitTreeManageable(id);
		}
		//over
	}
	if(beforeOpenSubNodes>0)
		return true;
	if(beforeOpenSubNodes==0 && state == -1){
		tree.openItem(id);
	}
    beforeOpenSubNodes = 1;
	return true;
}
function beforeOpenNode(id){
	beforeOpenSubNodes = tree.hasChildren(id);
	return true;
}
function getSubUnitTreeManageable(id){
	jQuery.ajax({
		url:webpath + "/UnitAction.do?method=getSubUnitTreeManageable",
		type:"post",
		async:false,
		dataType:"json",
		data:{id:id},
		success:function(data){
			if(data.errorMessage==null || data.errorMessage==undefined){
				for(var i=0;i<data.length;i++){
					if(data[i].MANAGEABLE != 1){
						tree.showItemCheckbox(data[i].UNIT_ID,false); //隐藏复选框
						tree.setItemColor(data[i].UNIT_ID,"#aaaaaa","#aaaaaa");//节点字体颜色置灰
					}
				}
			} else {
				if (data.errorMessage == "session timeout")
					window.location.href = webpath + "/login.jsp";
				else
					alert(data.errorMessage);
			}
		}
	});
}