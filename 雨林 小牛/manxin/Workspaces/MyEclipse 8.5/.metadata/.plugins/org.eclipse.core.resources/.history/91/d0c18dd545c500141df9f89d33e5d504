package com.yulin.web.Servlet;

import java.io.IOException;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.yulin.web.entity.SearchKey;
import com.yulin.web.entity.User;
import com.yulin.web.service.UserService;

public class Servlet extends HttpServlet{
	 
	private UserService us = new UserService();
	
	@Override
	protected void service(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		request.setCharacterEncoding("utf-8");
		response.setCharacterEncoding("utf-8");
		
		HttpSession session = request.getSession();
		String path = request.getRequestURI();
		path = path.substring(path.lastIndexOf("/"), path.lastIndexOf("."));
		
		if("/index".equals(path)){
			response.sendRedirect("emplist.do");
		}else if("/emplist".equals(path)){
			List<User> list = us.findAll();
//			System.out.println(list);
			session.setAttribute("list", list);
			response.sendRedirect("emplist.jsp");
		}else if("/addEmp".equals(path)){
			String id = request.getParameter("loginId");
			String name = request.getParameter("name");
			String pwd = "1234";
			int salary = Integer.parseInt(request.getParameter("salary"));
			int age = Integer.parseInt(request.getParameter("age"));
			User u = new User(id, pwd, name, salary, age);
			boolean bo = us.insertUser(u);
			response.sendRedirect("emplist.do");
		}else if("/update".equals(path)){
			String id = request.getParameter("id");
			String name = request.getParameter("name");
			String sal = request.getParameter("salary");
			String age = request.getParameter("age");
			String pwd = null;
			
			User u = new User(id,pwd,name,sal == null ? 0 : Integer.parseInt(sal),
					age == null ? 0 : Integer.parseInt(age));
			boolean bo = us.updateUser(u);
			response.sendRedirect("emplist.do");
		}else if("/search".equals(path)){
			System.out.println("hehe");
			String key = request.getParameter("key");
			String salMin = request.getParameter("min");
			String salMax = request.getParameter("max");
			
			System.out.println("hehe2");
			SearchKey searchkey = new SearchKey(key.equals("请输入关键字") ? null : "%" + key + "%",
					salMin.equals("最低工资") ? 0 : Integer.parseInt(salMin), 
					salMax.equals("最高工资") ? 0 : Integer.parseInt(salMax));
			response.sendRedirect("main.jsp");
			List<User> list = us.findSalary(searchkey);
			session.setAttribute("list", list);
//			response.sendRedirect("emplist.do");
			request.getRequestDispatcher("emplist.do").forward(request, response);
		}
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
}
