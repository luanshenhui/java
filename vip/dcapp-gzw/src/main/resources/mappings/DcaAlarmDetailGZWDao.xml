<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hepowdhc.dcapp.modules.gzw.dao.DcaAlarmDetailGZWDao">

	<sql id="dcaAlarmDetailColumns">
		a.ALARM_DETAIL_ID AS "alarmDetailId",
		a.BIZ_ROLE_ID AS
		"bizRoleId",
		a.POWER_ID AS "powerId",
		a.RISK_ID AS "riskId",
		a.BIZ_FLOW_ID AS "bizFlowId",
		a.BIZ_FLOW_NAME AS "bizFlowName",
		a.BIZ_OPER_PERSON AS "bizOperPerson",
		a.BIZ_OPER_POST AS "bizOperPost",
		a.BIZ_DATA_ID AS "bizDataId",
		a.BIZ_DATA_NAME AS "bizDataName",
		a.WF_ID AS "wfId",
		a.TASK_ID AS "taskId",
		a.TASK_NAME AS "taskName",
		a.ALARM_LEVEL AS "alarmLevel",
		a.ALARM_TYPE AS "alarmType",
		a.CPU_RESULT AS "cpuResult",
		a.ALARM_MSG AS "alarmMsg",
		a.ALARM_TIME_1ST AS "alarmTime1st",
		a.ALARM_STATUS AS "alarmStatus",
		a.VISUAL_SCOPE AS "visualScope",
		a.DEL_FLAG AS "delFlag",
		a.CREATE_PERSON AS "createPerson",
		a.CREATE_DATE AS "createDate",
		a.UPDATE_PERSON AS "updatePerson",
		a.UPDATE_DATE AS "updateDate",
		a.REMARKS AS "remarks"
	</sql>

	<sql id="dcaAlarmDetailColumnsForSelect">
		a.ALARM_DETAIL_ID AS "alarmDetailId",
		a.BIZ_ROLE_ID AS
		"bizRoleId",
		a.POWER_ID AS "powerId",
		a.RISK_ID AS "riskId",
		a.BIZ_FLOW_ID AS "bizFlowId",
		a.BIZ_FLOW_NAME AS "bizFlowName",
		a.BIZ_OPER_PERSON AS "bizOperPerson",
		a.BIZ_OPER_POST AS "bizOperPost",
		b.NAME AS "bizOperPostName",
		a.BIZ_DATA_ID AS "bizDataId",
		a.BIZ_DATA_NAME AS "bizDataName",
		a.WF_ID AS "wfId",
		a.TASK_ID AS
		"taskId",
		a.TASK_NAME AS "taskName",
		a.ALARM_LEVEL AS "alarmLevel",
		a.ALARM_TYPE AS "alarmType",
		a.CPU_RESULT AS "cpuResult",
		a.ALARM_MSG AS
		"alarmMsg",
		a.ALARM_TIME_1ST AS "alarmTime1st",
		a.ALARM_STATUS AS
		"alarmStatus",
		a.VISUAL_SCOPE AS "visualScope",
		a.DEL_FLAG AS "delFlag",
		a.CREATE_PERSON AS "createPerson",
		a.CREATE_DATE AS "createDate",
		a.UPDATE_PERSON AS "updatePerson",
		a.UPDATE_DATE AS "updateDate",
		a.REMARKS AS "remarks"
	</sql>

	<sql id="dcaAlarmDetailJoins">
	</sql>

	<sql id="dcaAlarmDetailJoinsForSelect">
		LEFT JOIN SYS_OFFICE b ON a.BIZ_OPER_POST = b.ID
	</sql>

	<select id="get" resultType="DcaAlarmDetail">
		SELECT
		<include refid="dcaAlarmDetailColumns" />
		FROM DCA_ALARM_DETAIL a
		<include refid="dcaAlarmDetailJoins" />
		WHERE a.ALARM_DETAIL_ID = #{alarmDetailId}
	</select>

	

	<select id="findAllList" resultType="DcaAlarmDetail">
		SELECT
		<include refid="dcaAlarmDetailColumns" />
		FROM DCA_ALARM_DETAIL a
		<include refid="dcaAlarmDetailJoins" />
		<where>
			a.DEL_FLAG = #{DEL_FLAG_NORMAL}
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.UPDATE_DATE DESC
			</otherwise>
		</choose>
	</select>

	<insert id="insert">
		INSERT INTO DCA_ALARM_DETAIL(
		ALARM_DETAIL_ID,
		BIZ_ROLE_ID,
		POWER_ID,
		RISK_ID,
		BIZ_FLOW_ID,
		BIZ_FLOW_NAME,
		BIZ_OPER_PERSON,
		BIZ_OPER_POST,
		BIZ_DATA_ID,
		BIZ_DATA_NAME,
		WF_ID,
		TASK_ID,
		TASK_NAME,
		ALARM_LEVEL,
		ALARM_TYPE,
		CPU_RESULT,
		ALARM_MSG,
		ALARM_TIME_1ST,
		ALARM_STATUS,
		VISUAL_SCOPE,
		DEL_FLAG,
		CREATE_PERSON,
		CREATE_DATE,
		UPDATE_PERSON,
		UPDATE_DATE,
		REMARKS
		) VALUES (
		#{alarmDetailId},
		#{bizRoleId},
		#{powerId},
		#{riskId},
		#{bizFlowId},
		#{bizFlowName},
		#{bizOperPerson},
		#{bizOperPost},
		#{bizDataId},
		#{bizDataName},
		#{wfId},
		#{taskId},
		#{taskName},
		#{alarmLevel},
		#{alarmType},
		#{cpuResult},
		#{alarmMsg},
		#{alarmTime1st},
		#{alarmStatus},
		#{visualScope},
		#{delFlag},
		#{createPerson},
		#{createDate},
		#{updatePerson},
		#{updateDate},
		#{remarks}
		)
	</insert>

	<update id="update">
		UPDATE DCA_ALARM_DETAIL SET
		ALARM_DETAIL_ID = #{alarmDetailId},
		BIZ_ROLE_ID = #{bizRoleId},
		POWER_ID = #{powerId},
		RISK_ID = #{riskId},
		BIZ_FLOW_ID = #{bizFlowId},
		BIZ_FLOW_NAME = #{bizFlowName},
		BIZ_OPER_PERSON = #{bizOperPerson},
		BIZ_OPER_POST = #{bizOperPost},
		BIZ_DATA_ID = #{bizDataId},
		BIZ_DATA_NAME = #{bizDataName},
		WF_ID = #{wfId},
		TASK_ID = #{taskId},
		TASK_NAME = #{taskName},
		ALARM_LEVEL = #{alarmLevel},
		ALARM_TYPE = #{alarmType},
		CPU_RESULT = #{cpuResult},
		ALARM_MSG = #{alarmMsg},
		ALARM_TIME_1ST = #{alarmTime1st},
		ALARM_STATUS = #{alarmStatus},
		VISUAL_SCOPE = #{visualScope},
		CREATE_PERSON = #{createPerson},
		UPDATE_PERSON = #{updatePerson},
		UPDATE_DATE = #{updateDate},
		REMARKS = #{remarks}
		WHERE ALARM_DETAIL_ID = #{alarmDetailId}
	</update>

	<update id="delete">
		UPDATE DCA_ALARM_DETAIL SET
		DEL_FLAG = #{DEL_FLAG_DELETE}
		WHERE ALARM_DETAIL_ID = #{alarmDetailId}
	</update>

	<select id="getAlarmDetailListByUpGrade" resultType="DcaAlarmDetail">
		SELECT
		<include refid="dcaAlarmDetailColumns" />
		FROM DCA_ALARM_DETAIL a
		WHERE a.DEL_FLAG = #{DEL_FLAG_NORMAL}
		AND a.POWER_ID = #{powerId}
		AND a.BIZ_ROLE_ID = #{bizRoleId}
		AND a.ALARM_LEVEL = #{alarmLevel}
	</select>


	<!-- 获取告警和风险项 -->
	<select id="getAlarmAndRisk" resultType="com.hepowdhc.dcapp.modules.alarm.entity.DcaAlarmDetail">
		SELECT u.NAME AS operPersonName,t.BIZ_OPER_PERSON AS bizOperPerson,t.ALARM_LEVEL AS alarmLevel,t.UPDATE_DATE AS updateDate,t.TYPE AS type FROM 
			(SELECT BIZ_OPER_PERSON,ALARM_LEVEL,UPDATE_DATE,TYPE FROM 
				(SELECT BIZ_OPER_PERSON,ALARM_LEVEL,ALARM_TIME_1ST AS UPDATE_DATE,1 AS TYPE 
				 FROM DCA_ALARM_DETAIL 
				 WHERE DEL_FLAG = '0'
				 <if test="powerId != null and powerId != ''">
					AND SUBSTR(POWER_ID, 0, 2) = #{powerId}
				 </if>
				 
				 UNION
				 SELECT BIZ_OPER_PERSON,ALARM_LEVEL,CREATE_DATE AS UPDATE_DATE,2 AS TYPE 
				 FROM DCA_RISK_MANAGE 
				 WHERE DEL_FLAG = '0'
				 <if test="powerId != null and powerId != ''">
					AND SUBSTR(POWER_ID, 0, 2) = #{powerId}
				 </if>
				 
				 ) m
			ORDER BY m.UPDATE_DATE DESC) t
		LEFT JOIN SYS_USER u on t.BIZ_OPER_PERSON = u.ID
		WHERE rownum <![CDATA[ <= ]]> 20
		ORDER BY t.UPDATE_DATE DESC
	</select>

</mapper>